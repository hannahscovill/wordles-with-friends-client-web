# Auto-setup new worktrees: copy .env and install deps
# git worktree add passes: prev_HEAD new_HEAD branch_flag
# branch_flag=1 for branch checkout, also set for worktree creation

main_worktree="$(git rev-parse --path-format=absolute --git-common-dir)/.."

# Only run when the current directory is NOT the main worktree (i.e. we're in a new worktree)
current_dir="$(pwd)"
main_dir="$(cd "$main_worktree" && pwd)"

if [ "$current_dir" != "$main_dir" ]; then
  if [ ! -f .env ] && [ -f "$main_dir/.env" ]; then
    cp "$main_dir/.env" .env
    echo "husky - copied .env from main worktree to $(basename "$current_dir")"
  fi

  if [ -f "$main_dir/.claude/settings.local.json" ]; then
    mkdir -p .claude
    cp "$main_dir/.claude/settings.local.json" .claude/settings.local.json
    echo "husky - copied .claude/settings.local.json from main worktree to $(basename "$current_dir")"
  fi

  if [ ! -d node_modules ]; then
    echo "husky - installing dependencies in $(basename "$current_dir")..."
    npm install
  fi
fi
